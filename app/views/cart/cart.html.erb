<!DOCTYPE html>
<html>
<head>
  <title>Your Shopping Cart</title>
  <style>
    .birdhouse-image {
      max-width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid #eee;
      margin-bottom: 20px;
    }
    /* Add additional styles as needed */
  </style>
</head>
<body>
<div class="cart-container">
  <h1 class="cart-header">Your Shopping Cart</h1>
  <% if @cart.cart_items.any? %>
    <div class="cart-items">
      <% @cart.cart_items.each do |cart_item| %>
        <div class="cart-item" id="cart-item-<%= cart_item.id %>">
          <%= image_tag "birdhouse#{cart_item.birdhouse.id}.jpg", class: 'birdhouse-image' %>
          <div class="item-details">
            <h2><%= cart_item.birdhouse.style %></h2>
            <p>
              Quantity: 
              <select name="cart_item[quantity]" id="cart_item_quantity_<%= cart_item.id %>"
                      data-item-id="<%= cart_item.id %>" data-unit-price="<%= cart_item.birdhouse.price %>"
                      class="quantity-dropdown">
                <% 1.upto(10) do |i| %>
                  <option value="<%= i %>" <%= 'selected' if cart_item.quantity == i %>><%= i %></option>
                <% end %>
              </select>
            </p>
            <p>Unit Price: <%= number_to_currency(cart_item.birdhouse.Price) %></p>
            <p>Total Price: <span id="item-total-<%= cart_item.id %>"><%= number_to_currency(cart_item.quantity * cart_item.birdhouse.Price) %></span></p>
            
            <td><%= button_to "Remove", buy_now_path(cart_item), method: :delete, data: { turbo: false } %></td>

          </div>
        </div>
      <% end %>
    </div>
    <div class="total-price">
      <p>Shipping Fee: 5.99 </p>
      <p>Taxes: 3.99 </p>
      <strong>Total price (Including Shipping and Taxes):</strong>
      <span id="cart-total"><%= number_to_currency(@total_price) %></span>
      <%= link_to 'Proceed to Checkout', '#', class: 'btn btn-primary' %>
    </div> 
  <% else %>
    <p>Your cart is currently empty.</p>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.quantity-dropdown').forEach(function(select) {
      select.addEventListener('change', function() {
        var itemTotalSpan = document.getElementById('item-total-' + this.dataset.itemId);
        var cartTotalSpan = document.getElementById('cart-total');
        var unitPrice = parseFloat(this.dataset.unitPrice);
        var quantity = parseInt(this.value);
        var itemTotal = unitPrice * quantity;
        
        itemTotalSpan.textContent = itemTotal.toFixed(2); // Format as needed

        // Calculate and update the new cart total
        var cartTotal = 0;
        document.querySelectorAll('.quantity-dropdown').forEach(function(sel) {
          var itemPrice = parseFloat(sel.dataset.unitPrice);
          var itemQty = parseInt(sel.value);
          cartTotal += itemPrice * itemQty;
        });
        
        cartTotal += 5.99 + 3.99; // Add shipping and taxes
        cartTotalSpan.textContent = cartTotal.toFixed(2); // Format as needed

        // AJAX call to update the quantity in the cart on the server side
        fetch('/cart_items/' + this.dataset.itemId, { // Replace with your actual route
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
          },
          body: JSON.stringify({
            cart_item: { quantity: this.value }
          })
        })
        .then(response => response.json())
        .then(data => {
          itemTotalSpan.textContent = data.item_total; // Assuming your server sends back the item total
          cartTotalSpan.textContent = data.cart_total; // Assuming your server sends back the cart total
        })
        .catch(error => console.error('Error:', error));
      });
    });
  });
</script>

</body>
</html>
